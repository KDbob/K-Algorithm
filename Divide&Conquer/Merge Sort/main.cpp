//
//  main.cpp
//  Merge Sort
//
//  Created by kaide on 2020/10/26.
//  Copyright Â© 2020 kaide. All rights reserved.
//

#include <iostream>

using namespace std;

/**
 * åˆå¹¶ä¸¤ä¸ªæœ‰åºçš„å­æ•°ç»„( A[p]~A[q]åŠA[q+l]~A[r]å·²æŒ‰é€’å¢é¡ºåºæ’åº )
 * @param A æ•´æ•°æ•°ç»„
 * @param p ç¬¬ä¸€ä¸ªå­æ•°ç»„çš„èµ·å§‹ä¸‹æ ‡
 * @param q ç¬¬ä¸€ä¸ªå­æ•°ç»„çš„æœ«å°¾ä¸‹æ ‡
 * @param r ç¬¬äºŒä¸ªå­—æ•°ç»„çš„æœ«å°¾ä¸‹æ ‡
 * @param n Aæ•°ç»„çš„å…ƒç´ ä¸ªæ•°
 */
void merge(int A[], int p, int q, int r, int n) {
    int *B = new int[n];        // å»ºç«‹ç¼“å†²åŒº
    int k = 0;                  // æŒ‡å‘Bçš„æ¸¸æ ‡ï¼Œä¸»è¦ç”¨äºæ’å…¥æ•°æ®è¿›Bä¸­
    int i = p, j = q + 1;
    while (i <= q && j <= r) {                  // whileå¾ªç¯çš„è·³å‡ºæ¡ä»¶æ˜¯ï¼šiå’Œjåªè¦æœ‰ä¸€ä¸ªè¶…è¿‡å„ç§æ•°ç»„çš„ç•Œé™
        if (A[i] >= A[j]) {
            B[k++] = A[j++];
        } else {
            B[k++] = A[i++];
        }
    }
    if (i == q+1) {    // è¯´æ˜æ˜¯å‰åŠæ®µå…ˆéå†å®Œï¼ŒæŠŠååŠæ®µçš„æ‹¼åˆ°æ•°ç»„åé¢
        while (j <= r) {
            B[k++] = A[j++];
        }
    } else {
        while (i <= q) {
            B[k++] = A[i++];
        }
    }
    // å°†é€‰å®šçš„éƒ¨åˆ†æ›¿æ¢ä¸ºBçš„æ•°ç»„
    k = 0;
    for (i = p; i <= r; i++) {
        A[i] = B[k++];
    }
    delete[] B;
}

/**
 * åˆå¹¶æ’åºç®—æ³•
 * @param A ä¹±åºæ•°ç»„A
 * @param n æ•°ç»„Açš„å…ƒç´ ä¸ªæ•°
 */
void merge_sort(int A[], int n) {
    int i,s;  // i: å¼€å§‹åˆå¹¶æ—¶ç¬¬ä¸€ä¸ªåºåˆ—çš„èµ·å§‹ä½ç½®ï¼Œsï¼šåˆå¹¶å‰åºåˆ—çš„å¤§å°ï¼Œtï¼šåˆå¹¶ååºåˆ—çš„å¤§å°
    int t = 1;
    while (t < n) {  // å¤–å±‚å¾ªç¯ï¼šåˆå¹¶çš„å¤§è¶Ÿæ•°
        s = t;
        t *=2;
        i = 0;
        while (i + t < n) { // å†…å±‚å¾ªç¯ï¼šæ¯è¶Ÿéœ€è¦åˆå¹¶çš„æ¬¡æ•°
            merge(A, i, i+s-1, i+s*2-1, t); // ğŸ’¡éš¾ç‚¹ï¼šå¡«å†™å˜é‡çš„å‚æ•°
            i = i + t;
        }
        if (i + s < n) {  // ğŸ’¡éš¾ç‚¹ï¼šåˆ¤æ–­è¿˜æœ‰å‰©ä¸‹çš„å…ƒç´ å¾…å¤„ç†ã€‚
            merge(A, i, i+s-1, n-1, n-i);
        }
    }
}

/**
 ä»æ•°ç»„ä¸­ï¼Œæ¯5ä¸ªå…ƒç´ ä¸ºä¸€ç»„ï¼Œå–ç¬¬iç»„çš„ä¸­å€¼å…ƒç´ äºæ•°ç»„p
 */
void mid(int A[], int i, int p[]){
    int k = 5 * i;
    if (A[k] > A[k+2]) {
        swap(A[k+2], A[k]);
    }
    if (A[k+1] > A[k+3]) {
        swap(A[k+3], A[k+1]);
    }
    if (A[k] > A[k+1]) {
        swap(A[k], A[k+1]);
    }
    if (A[k+2] > A[k+3]) {
        swap(A[k+2], A[k+3]);
    }
    if (A[k+1] > A[k+2]) {
        swap(A[k+1], A[k+2]);
    }
    if (A[k+4] > A[k+2]) {
        p[i] = A[k+2];
    } else if (A[k+4] > A[k+1]) {
        p[i] = A[k+4];
    } else {
        p[i] = A[k+1];
    }
}

/**
    é€‰æ‹©ç®—æ³•
    è¾“å…¥ï¼šnä¸ªå…ƒç´ çš„æ•°ç»„A[]ï¼Œæ‰€è¦é€‰æ‹©çš„ç¬¬kå°çš„å…ƒç´ 
    è¾“å‡ºï¼šæ‰€é€‰æ‹©çš„å…ƒç´ 
 */
int select(int A[], int n, int k) {
    int i, p, q, r;
    int m, *P, *Q, *R;
    if (n <= 3) {   // å…ƒç´ ä¸ªæ•°å°äºé˜€å€¼ï¼Œç›´æ¥æ’åº
        merge_sort(A, n);
        return A[k - 1];    // è¿”å›ç¬¬kå°å…ƒç´ 
    }
    // æŠŠåŸæ•°ç»„åˆ’åˆ†æˆP,Q,Rä¸‰ç»„ï¼Œä½¿å¾—å°äºmçš„å…ƒç´ å­˜æ”¾äºPï¼Œç­‰äºmçš„å…ƒç´ å­˜æ”¾äºQï¼Œå¤§äºmçš„å…ƒç´ å­˜æ”¾äºR
    P = new int[3*n/4];     // é€šè¿‡æ•°å­¦è®¡ç®—å¾—åˆ°çš„ï¼šæ•°ç»„è§„æ¨¡æœ€å¤§ä¹Ÿåªæœ‰ä»¥å‰çš„3/4
    Q = new int[3*n/4];
    R = new int[3*n/4];
    for (i=0; i<n/5; i++) { // æŠŠæ¯ç»„5ä¸ªå…ƒç´ çš„ä¸­å€¼å…ƒç´ ä¾æ¬¡å­˜äºP
        mid(A, i, P);
    }
    
    m = select(P, i, i/2+i%2);  // é€’å½’ç¬¬è°ƒç”¨ï¼Œå–å¾—ä¸­å€¼å…ƒç´ çš„ä¸­å€¼å…ƒç´ ï¼šmï¼ˆå·§å¦™ç‚¹ï¼šè¿™ä¸ªå‡½æ•°ä¹Ÿèƒ½è¿”å›ä¸­å€¼ï¼‰
    p = q = r = 0;
    for (int i=0; i<n; i++) {
        if (A[i] < m) {
            P[p++] = A[i];
        } else if (A[i] > m) {
            R[r++] = A[i];
        } else {
            Q[q++] = A[i];
        }
    }
    // 2.åˆ’åˆ†æˆå­é—®é¢˜
    if (p > k) {  // ç¬¬kå°çš„å…ƒç´ åœ¨æ•°ç»„Pä¸­ï¼Œç»§ç»­åœ¨Pä¸­è¿›è¡Œå¯»æ‰¾ã€‚
        return select(P, p, k);
    } else if (p+q >= k) { // ç¬¬kå°çš„å…ƒç´ åœ¨Qä¸­ï¼Œç›´æ¥è¿”å›m
        return m;
    } else {    // ç¬¬kå°çš„å…ƒç´ åœ¨Rä¸­ï¼Œåœ¨Rä¸­ç»§ç»­å¯»æ‰¾
        return select(R, r, k-p-q);
    }
}

void test_select(){
    int a[] = {8,31,60,33,17,4,51,57,49,35,11,43,37,3,13,52,6,19,25,32,54,16,5,41,7,23,22,46,29};
    int k = select(a, 29, 18);
    printf("%d", k);
}

/**
 * åˆå¹¶æ’åºçš„é€’å½’å®ç°ï¼ˆåˆ†æ²»æ³•ï¼‰
 * @param A ä¹±åºçš„æ•°ç»„A
 * @param low æ•°ç»„çš„èµ·å§‹ä¸‹æ ‡
 * @param high æ•°ç»„çš„æœ«å°¾ä¸‹æ ‡
 */
void merge_sort(int A[], int low, int high) {
    if (low < high) {   // è¯´æ˜è‡³å°‘è¿˜å­˜åœ¨ä¸¤ä¸ªå…ƒç´ ï¼šéœ€è¦è¿›è¡Œåˆ†
        int i = (low + high) / 2;       // è·å¾—ä¸­é—´ä½ç½®çš„ä¸‹æ ‡(åå·¦)
        merge_sort(A, low, i);          // åˆ†æ“ä½œï¼šå¯¹å·¦åŠéƒ¨åˆ†çš„å­åºåˆ—é€’å½’è°ƒç”¨
        merge_sort(A, i+1, high);   // åˆ†æ“ä½œï¼šå¯¹å³åŠéƒ¨åˆ†çš„å­åºåˆ—é€’å½’è°ƒç”¨
        merge(A, low, i, high, high-low+1); // æ²»æ“ä½œï¼šè§£å†³æœ‰åºä¸¤ä¸ªå­åºåˆ—çš„åˆå¹¶
    }
}

int main() {
    int a[] = {8, 5, 3, 9, 11, 6, 4, 1, 10, 7, 2, 11};
    merge_sort(a, 0, 10);   // å½’å¹¶æ’åºçš„éé€’å½’å®ç°
    for (int i=0;i < 11; i++) {
        printf("%d ",a[i]);
    }
    // 1 2 3 4 5 6 7 8 9 10 11
}


void test() {
    // insert code here...
        int a[] = {1, 3, 5, 7, 9, 2, 4, 6, 8, 10};
        merge(a, 0, 4, 9, 10);
        // æµ‹è¯•ä¸¤ä¸ªå…ƒç´ çš„æ•°ç»„
//        int a2[] = {6, 2};
//        merge(a2, 0, 0, 1, 2);
//        int a[] = {8,7,6,5,4,3,2,1};
        merge_sort(a, 8);

//        merge(a, 0, 0, 1, 2);
//        merge(a, 2, 2, 3, 2);
        // æµ‹è¯•mide
    //    int a[] = {1,2,3,5,4};
    //    int *p = new int(2);
    //    mid(a, 0, p);

}
